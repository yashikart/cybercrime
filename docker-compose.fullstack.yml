version: "3.9"

services:
  postgres:
    image: postgres:16-alpine
    container_name: cybercrime-postgres
    environment:
      POSTGRES_DB: cybercrime
      POSTGRES_USER: cybercrime_user
      POSTGRES_PASSWORD: cybercrime_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cybercrime_user -d cybercrime"]
      interval: 10s
      timeout: 5s
      retries: 10

  zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: cybercrime-zookeeper
    environment:
      ALLOW_ANONYMOUS_LOGIN: "yes"
    ports:
      - "2181:2181"
    healthcheck:
      test: ["CMD-SHELL", "echo ruok | nc -w 2 127.0.0.1 2181 | grep imok || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12

  kafka:
    image: bitnami/kafka:3.7
    container_name: cybercrime-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    environment:
      KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
    ports:
      - "9092:9092"
    healthcheck:
      test: ["CMD-SHELL", "unset JMX_PORT; /opt/bitnami/kafka/bin/kafka-topics.sh --bootstrap-server 127.0.0.1:9092 --list >/dev/null 2>&1 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10

  backend:
    image: python:3.12-slim
    container_name: cybercrime-backend
    working_dir: /app/backend
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://cybercrime_user:cybercrime_password@postgres:5432/cybercrime
      HOST: 0.0.0.0
      PORT: 3000
      DEBUG: "false"
      EXPOSE_API_DOCS: "false"
      RBAC_POLICY_PATH: /app/rbac-permissions.json
      SECRET_KEY: change-this-in-real-deployment
      EMAIL_ENABLED: "false"
      BHIV_BUCKET_EVIDENCE_URL: ""
      BHIV_BUCKET_API_KEY: ""
      BHIV_CORE_EVENT_URL: ""
      EVENT_BUFFER_PATH: /app/backend/event_buffer/events.jsonl
    command: >
      sh -c "pip install --no-cache-dir -r requirements.txt &&
             uvicorn main:app --host 0.0.0.0 --port 3000"
    ports:
      - "3000:3000"
    volumes:
      - ./:/app
      - evidence_data:/app/backend/evidence_storage
      - event_buffer_data:/app/backend/event_buffer
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://127.0.0.1:3000/health', timeout=5).read()\""]
      interval: 15s
      timeout: 7s
      retries: 10

  frontend:
    image: node:22-alpine
    container_name: cybercrime-frontend
    working_dir: /app/frontend
    depends_on:
      backend:
        condition: service_healthy
    environment:
      VITE_API_URL: http://localhost:3000/api/v1
    command: >
      sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 5173"
    ports:
      - "5173:5173"
    volumes:
      - ./:/app
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://127.0.0.1:5173 >/dev/null 2>&1 || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 10

volumes:
  postgres_data:
  evidence_data:
  event_buffer_data:
